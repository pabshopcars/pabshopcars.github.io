<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAB SHOP ‚Äî Cars for Sale</title>
  <meta name="description" content="Curated cars for sale ‚Äî contact us directly to purchase.">

  <!-- Faster font loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Sharing previews -->
  <meta property="og:title" content="PAB SHOP ‚Äî Cars for Sale">
  <meta property="og:description" content="Clean listings. Clear pricing. Direct contact.">
  <meta property="og:type" content="website">

  <meta name="google-site-verification" content="evnpLoU4TEYreEXpPrIDMKN0ASQL9bB6PMvvnywPwNU" />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --text:#0f1724;
      --accent:#0b6eff;
      --glass:rgba(255,255,255,0.65);
      --shadow:0 6px 20px rgba(12,15,20,0.06);
      --border:rgba(0,0,0,0.04);

      --graybtn-bg:rgba(15,23,36,0.06);
      --graybtn-bg-hover:rgba(15,23,36,0.10);
      --graybtn-border:rgba(15,23,36,0.10);
      --warn: #ff4d4d;
      --ok: #10b981;
    }
    [data-theme="dark"]{
      --bg:#0b0f16;
      --card:#0f1724;
      --muted:#94a3b8;
      --text:#e6eef8;
      --accent:#4ea8ff;
      --glass:rgba(255,255,255,0.05);
      --shadow:0 10px 30px rgba(0,0,0,0.6);
      --border:rgba(255,255,255,0.03);

      --graybtn-bg:rgba(255,255,255,0.06);
      --graybtn-bg-hover:rgba(255,255,255,0.10);
      --graybtn-border:rgba(255,255,255,0.10);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Inter,system-ui;
      background:var(--bg);
      color:var(--text);
      transition:background 0.4s ease, color 0.4s ease;
      line-height:1.6;
    }
    .container{max-width:1200px;margin:0 auto;padding:0 20px}

    header .container{ padding:10px 20px; }

    header{
      position:sticky;
      top:0;
      z-index:100;
      backdrop-filter:blur(12px) saturate(180%);
      background:var(--glass);
      border-bottom:1px solid var(--border);
      transition:all 0.4s ease;
    }
    .header-inner{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 0;
    }
    .logo{
      font-weight:700;
      color:var(--accent);
      font-size:22px;
      letter-spacing:-0.5px;
      text-decoration:none;
    }
    nav{display:flex;gap:8px;align-items:center}
    nav a{
      padding:10px 16px;
      color:var(--muted);
      text-decoration:none;
      font-weight:600;
      border-radius:8px;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      font-size:15px;
    }
    nav a:hover{
      color:var(--text);
      background:var(--glass);
      transform:translateY(-1px);
    }

    .settings-toggle{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:50%;
      padding:10px;
      width:44px;
      height:44px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--text);
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:var(--shadow);
    }
    .settings-toggle:hover{
      transform:scale(1.08);
      box-shadow:0 8px 25px rgba(0,0,0,0.1);
    }
    .settings-toggle:active{transform:scale(0.98)}
    .settings-icon{font-size:20px;transition:transform 0.6s ease}
    .settings-toggle:hover .settings-icon{transform:rotate(90deg)}

    /* Settings Modal */
    .settings-overlay{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.5);
      backdrop-filter:blur(4px);
      z-index:1000;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.3s ease;
      padding:16px;
    }
    .settings-overlay.active{
      opacity:1;
      pointer-events:all;
    }

    .settings-modal{
      background:var(--card);
      border-radius:20px;
      padding:32px;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      border:1px solid var(--border);
      max-width:500px;
      width:90%;
      transform:scale(0.8) translateY(-20px);
      transition:transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      outline:none;
    }
    .settings-overlay.active .settings-modal{
      transform:scale(1) translateY(0);
    }

    .settings-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:28px;
    }
    .settings-header h2{
      font-size:26px;
      color:var(--text);
      font-weight:700;
    }
    .close-btn{
      background:none;
      border:none;
      font-size:28px;
      color:var(--muted);
      cursor:pointer;
      transition:all 0.2s ease;
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
    }
    .close-btn:hover{
      background:var(--glass);
      color:var(--text);
      transform:rotate(90deg);
    }

    .settings-section{ margin-bottom:28px; }
    .settings-section:last-child{ margin-bottom:0; }
    .settings-section h3{
      font-size:16px;
      color:var(--text);
      margin-bottom:14px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      opacity:0.8;
    }

    .theme-buttons{ display:flex; gap:12px; }
    .theme-btn{
      flex:1;
      padding:16px;
      border:2px solid var(--border);
      border-radius:12px;
      background:var(--card);
      cursor:pointer;
      transition:all 0.3s ease;
      font-weight:600;
      font-size:15px;
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .theme-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,0,0,0.1);
    }
    .theme-btn.active{
      border-color:var(--accent);
      background:var(--accent);
      color:#fff;
    }

    .hero{
      padding:60px 0 40px;
      text-align:center;
    }
    .hero h1{
      font-size:clamp(32px,6vw,52px);
      margin:0 0 12px;
      color:var(--text);
      font-weight:700;
      letter-spacing:-1px;
    }
    .hero p{
      color:var(--muted);
      font-size:18px;
      margin-bottom:30px;
    }

    .controls{
      display:flex;
      gap:14px;
      max-width:760px;
      margin:0 auto;
      flex-wrap:wrap;
      justify-content:center;
      align-items:stretch;
    }
    .search{
      flex:1;
      min-width:250px;
      background:var(--card);
      border-radius:12px;
      padding:14px 18px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      transition:all 0.3s ease;
    }
    .search:focus-within{
      transform:translateY(-2px);
      box-shadow:0 12px 30px rgba(11,110,255,0.15);
      border-color:var(--accent);
    }
    .search input{
      border:0;
      width:100%;
      background:none;
      outline:none;
      color:var(--text);
      font-size:16px;
      font-family:inherit;
    }
    .search input::placeholder{color:var(--muted);opacity:0.7}

    .btn{
      display:inline-block;
      padding:14px 28px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--accent),#2b8fff);
      color:#fff;
      text-decoration:none;
      font-weight:600;
      font-size:16px;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 4px 15px rgba(11,110,255,0.3);
      cursor:pointer;
      border:none;
    }
    .btn:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 25px rgba(11,110,255,0.4);
    }
    .btn:active{transform:translateY(-1px)}

    .sold-link{
      display:inline-block;
      padding:12px 24px;
      margin-top:8px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--muted);
      text-decoration:none;
      font-weight:600;
      font-size:15px;
      transition:all 0.3s ease;
      box-shadow:var(--shadow);
    }
    .sold-link:hover{
      color:var(--text);
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,0,0,0.1);
    }

    #cars{padding:50px 20px}

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:28px;
      margin-top:40px;
    }

    .card{
      background:var(--card);
      border-radius:16px;
      overflow:hidden;
      box-shadow:var(--shadow);
      transition:all 0.4s cubic-bezier(0.4,0,0.2,1);
      border:1px solid var(--border);
      cursor:pointer;
    }
    .card:hover{
      transform:translateY(-8px) scale(1.02);
      box-shadow:0 20px 40px rgba(0,0,0,0.15);
      border-color:var(--accent);
    }
    .card-img-wrap{
      position:relative;
      overflow:hidden;
      height:220px;
      background:rgba(0,0,0,0.04);
    }
    .card img{
      width:100%;
      height:100%;
      object-fit:cover;
      transition:transform 0.6s cubic-bezier(0.4,0,0.2,1);
      display:block;
    }
    .card:hover img{transform:scale(1.1)}

    .card-body{padding:20px}
    .card h3{
      margin:0 0 10px;
      font-size:20px;
      color:var(--text);
      font-weight:700;
    }
    .price{
      font-weight:700;
      margin:8px 0;
      color:var(--accent);
      font-size:24px;
      letter-spacing:-0.5px;
    }
    .card p{
      margin:0;
      color:var(--muted);
      font-size:14px;
    }

    /* admin action buttons */
    .action-buttons{
      display:flex;
      gap:16px;
      width:100%;
      padding:0;
      margin-top:16px;
    }
    .action-btn{
      flex:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:18px 24px;
      text-decoration:none;
      font-weight:800;
      font-size:16px;
      border-radius:12px;
      cursor:pointer;
      border:none;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 4px 15px rgba(0,0,0,0.18);
      white-space:nowrap;
    }
    .action-btn:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 25px rgba(0,0,0,0.22);
    }
    .action-btn:active{ transform:translateY(-1px); }

    .action-btn.sold{
      background:linear-gradient(135deg,#fbbf24,#f59e0b);
      color:#111827;
      box-shadow:0 4px 15px rgba(245,158,11,0.35);
    }
    .action-btn.sold:hover{
      box-shadow:0 8px 25px rgba(245,158,11,0.45);
    }

    .action-btn.delete{
      background:linear-gradient(135deg,#ff4d4d,#dc2626);
      color:#fff;
      box-shadow:0 4px 15px rgba(220,38,38,0.35);
    }
    .action-btn.delete:hover{
      box-shadow:0 8px 25px rgba(220,38,38,0.45);
    }

    /* Add Car Modal form */
    .modal-note{
      color:var(--muted);
      font-size:13px;
      margin-top:-10px;
      margin-bottom:14px;
    }
    .form-grid{ display:grid; gap:12px; }
    .form-row{ display:grid; gap:8px; }
    .form-row label{
      font-weight:700;
      font-size:13px;
      color:var(--text);
      opacity:0.9;
    }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button{
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number]{ -moz-appearance:textfield; }

    .form-row input{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      outline:none;
      transition:all 0.2s ease;
      font-family:inherit;
      font-size:14px;
      -moz-appearance:textfield;
    }
    .form-row input:focus{
      border-color:var(--accent);
      box-shadow:0 10px 30px rgba(11,110,255,0.12);
      transform:translateY(-1px);
    }

    .modal-actions{
      display:flex;
      gap:10px;
      margin-top:16px;
    }
    .modal-actions .mini-btn{
      flex:1;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      font-weight:800;
      cursor:pointer;
      transition:all 0.2s ease;
      box-shadow:var(--shadow);
    }
    .modal-actions .mini-btn:hover{
      transform:translateY(-1px);
      border-color:var(--accent);
    }
    .modal-actions .primary{
      background:linear-gradient(135deg,var(--accent),#2b8fff);
      color:#fff;
      border-color:transparent;
      box-shadow:0 6px 18px rgba(11,110,255,0.28);
    }
    .modal-actions .primary:hover{
      box-shadow:0 10px 24px rgba(11,110,255,0.38);
    }

    #contact{
      padding:60px 0;
      text-align:center;
    }
    #contact h2{
      color:var(--text);
      margin-bottom:16px;
      font-size:32px;
      font-weight:700;
    }
    #contact p{
      color:var(--muted);
      font-size:16px;
      margin-bottom:24px;
    }

    .contact-buttons{
      display:flex;
      gap:16px;
      max-width:600px;
      margin:0 auto;
      justify-content:center;
      flex-direction:column;
      padding:0 20px;
    }
    .contact-btn{
      display:inline-block;
      padding:18px 32px;
      background:linear-gradient(135deg,var(--accent),#2b8fff);
      color:#fff;
      text-align:center;
      text-decoration:none;
      font-weight:700;
      font-size:18px;
      border-radius:12px;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 4px 15px rgba(11,110,255,0.3);
      width:100%;
      min-width:auto;
    }
    .contact-btn:hover{
      transform:translateY(-3px);
      box-shadow:0 8px 25px rgba(11,110,255,0.4);
    }
    .contact-btn.email{
      background:linear-gradient(135deg,#10b981,#059669);
      box-shadow:0 4px 15px rgba(16,185,129,0.3);
    }
    .contact-btn.email:hover{
      box-shadow:0 8px 25px rgba(16,185,129,0.4);
    }
    .contact-btn.secondary{
      background: var(--card);
      color: var(--accent);
      border: 2px solid var(--accent);
      box-shadow: var(--shadow);
    }
    .contact-btn.secondary:hover{
      background: var(--glass);
      transform: translateY(-3px);
    }

    footer{
      text-align:center;
      padding:40px 0;
      color:var(--muted);
      border-top:1px solid var(--border);
      margin-top:60px;
      font-size:14px;
    }

    /* admin view buttons */
    .view-btn-active{
      background: linear-gradient(135deg, var(--accent), #2b8fff);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 6px 18px rgba(11,110,255,0.35);
    }
    .view-btn-inactive{
      background: var(--card);
      color: var(--muted);
      border: 2px solid var(--border);
    }

    /* ====== Pretty confirm modal ====== */
    .pab-confirm-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.55);
      backdrop-filter:blur(4px);
      z-index:5000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .pab-confirm-modal{
      width:min(560px, 95vw);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.35);
      overflow:hidden;
      transform:scale(0.95) translateY(10px);
      opacity:0;
      transition:transform 0.2s ease, opacity 0.2s ease;
    }
    .pab-confirm-overlay.active{ display:flex; }
    .pab-confirm-overlay.active .pab-confirm-modal{
      transform:scale(1) translateY(0);
      opacity:1;
    }
    .pab-confirm-head{
      padding:18px 18px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(135deg, rgba(11,110,255,0.08), rgba(11,110,255,0.03));
    }
    [data-theme="dark"] .pab-confirm-head{
      background:linear-gradient(135deg, rgba(78,168,255,0.12), rgba(255,255,255,0.03));
    }
    .pab-confirm-title{
      font-weight:900;
      letter-spacing:-0.3px;
      font-size:16px;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pab-confirm-icon{
      width:34px; height:34px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      background:var(--glass);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .pab-confirm-close{
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--glass);
      color:var(--text);
      font-size:22px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:transform 0.2s ease;
    }
    .pab-confirm-close:hover{ transform:rotate(90deg); }
    .pab-confirm-body{
      padding:16px 18px 0;
      color:var(--muted);
      font-size:15px;
      line-height:1.6;
    }
    .pab-confirm-actions{
      padding:18px;
      display:flex;
      gap:12px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .pab-confirm-btn{
      border:none;
      border-radius:12px;
      padding:12px 16px;
      font-weight:900;
      cursor:pointer;
      transition:all 0.25s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 4px 15px rgba(0,0,0,0.18);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-width:120px;
      font-size:14px;
    }
    .pab-confirm-btn:active{ transform:translateY(-1px); }
    .pab-confirm-btn.cancel{
      background:linear-gradient(135deg, rgba(15,23,36,0.10), rgba(15,23,36,0.18));
      color:var(--text);
    }
    [data-theme="dark"] .pab-confirm-btn.cancel{
      background:linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.14));
      color:#fff;
      box-shadow:0 4px 15px rgba(0,0,0,0.35);
    }
    .pab-confirm-btn.cancel:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,0,0,0.22); }

    .pab-confirm-btn.ok{
      background:linear-gradient(135deg,var(--accent),#2b8fff);
      color:#fff;
      box-shadow:0 4px 15px rgba(11,110,255,0.35);
    }
    .pab-confirm-btn.ok:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(11,110,255,0.45); }

    .pab-confirm-btn.warn{
      background: linear-gradient(135deg,#fbbf24,#f59e0b);
      color:#111827;
      box-shadow:0 4px 15px rgba(245,158,11,0.35);
    }
    .pab-confirm-btn.warn:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 25px rgba(245,158,11,0.45);
    }

    .pab-confirm-btn.danger{
      background:linear-gradient(135deg,#ff4d4d,#dc2626);
      color:#fff;
      box-shadow:0 4px 15px rgba(220,38,38,0.35);
    }
    .pab-confirm-btn.danger:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(220,38,38,0.45); }
    /* ====== end confirm modal ====== */

    /* status + loader */
    .grid-status{
      margin-top:18px;
      text-align:center;
      color:var(--muted);
      font-weight:700;
      display:none;
    }
    .grid-status.show{ display:block; }
    .grid-spinner{
      width:34px;
      height:34px;
      border-radius:50%;
      border:3px solid rgba(127,127,127,0.18);
      border-top-color: var(--accent);
      margin:12px auto 0;
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    @media(max-width:768px){
      .header-inner{padding:12px 0 }
      nav{
        display:flex;
        flex-wrap:wrap;
        justify-content:center;
        gap:6px;
      }
      nav a{
        padding:8px 14px;
        font-size:14px;
      }
      .hero{padding:40px 0 30px}
      .hero h1{font-size:36px}
      .controls{flex-direction:column;padding:0 20px}
      .btn{width:100%;text-align:center}
      .sold-link{width:100%;text-align:center;margin-top:12px}
      .grid{grid-template-columns:1fr;gap:24px}
      .settings-modal{padding:24px}
      .contact-buttons{ flex-direction:column; padding:0 20px; }
      .contact-btn{ width:100%; min-width:auto; }
      .action-buttons{ gap:12px; }
      .action-btn{ padding:16px 16px; font-size:15px; }

      /* iOS Safari zoom fix for Add Car inputs */
      #addCarOverlay input{
        font-size:16px !important;
      }

      /* ‚úÖ Mobile layout toggle: compact = 2 columns (ONLY on mobile) */
      html[data-mobile-grid="double"] .grid{
        grid-template-columns:repeat(2, 1fr);
        gap:14px;
      }
      html[data-mobile-grid="double"] .card-img-wrap{ height:160px; }
      html[data-mobile-grid="double"] .card-body{ padding:14px; }
      html[data-mobile-grid="double"] .card h3{ font-size:16px; margin-bottom:6px; }
      html[data-mobile-grid="double"] .price{ font-size:18px; margin:6px 0; }
      html[data-mobile-grid="double"] .card p{ font-size:12px; }
      html[data-mobile-grid="double"] .action-buttons{ flex-direction:column; gap:10px; }
      html[data-mobile-grid="double"] .action-btn{ padding:14px 12px; font-size:14px; }
    }

    @media(max-width:480px){
      .logo{font-size:20px}
      .settings-toggle{padding:8px;width:40px;height:40px}
      .settings-icon{font-size:18px}
    }
  </style>
</head>

<body>

<header>
  <div class="container header-inner">
    <a href="index.html" class="logo">PAB SHOP</a>
    <nav>
      <a href="#home">Home</a>
      <a href="#cars">Cars</a>
      <a href="#contact">Contact</a>
    </nav>
    <button id="settingsToggle" class="settings-toggle" aria-haspopup="dialog" aria-controls="settingsOverlay">
      <span class="settings-icon">‚öôÔ∏è</span>
    </button>
  </div>
</header>

<!-- Settings Modal -->
<div class="settings-overlay" id="settingsOverlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="settings-modal" tabindex="-1" aria-label="Settings">
    <div class="settings-header">
      <h2>Settings</h2>
      <button class="close-btn" id="closeSettings" aria-label="Close settings">√ó</button>
    </div>

    <div class="settings-section">
      <h3>Theme Mode</h3>
      <div class="theme-buttons">
        <button class="theme-btn" data-theme="light"><span>‚òÄÔ∏è</span><span>Light</span></button>
        <button class="theme-btn" data-theme="dark"><span>üåô</span><span>Dark</span></button>
      </div>
    </div>

    <!-- ‚úÖ Layout toggle visible for everyone -->
    <div class="settings-section">
      <h3>Mobile Layout</h3>
      <div class="theme-buttons">
        <button class="theme-btn" id="layoutSingleBtn" type="button"><span>‚ñ¶</span><span>1 per row</span></button>
        <button class="theme-btn" id="layoutDoubleBtn" type="button"><span>‚ñ¶‚ñ¶</span><span>2 per row</span></button>
      </div>
      <p style="color:var(--muted); font-size:13px; margin-top:10px;">
        Only affects small screens. Desktop stays the same.
      </p>
    </div>

    <!-- Owner login trigger -->
    <div class="settings-section" id="ownerLoginSection">
      <h3>Secret</h3>
      <button id="showOwnerLoginBtn" class="theme-btn" style="width:100%;">Secret</button>
    </div>

    <!-- Admin section -->
    <div class="settings-section" id="adminSection" style="display:none;">
      <h3>Admin</h3>

      <div id="authLoggedOut" style="display:none;">
        <input id="adminEmail" type="email" placeholder="Owner email"
          style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--border); margin-bottom:10px;">
        <input id="adminPassword" type="password" placeholder="Password"
          style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--border); margin-bottom:10px;">
        <button id="loginBtn" class="theme-btn" style="width:100%;">Login</button>
      </div>

      <div id="authLoggedIn" style="display:none;">
        <p id="adminEmailLabel" style="color:var(--muted); margin-bottom:12px;"></p>
        <button id="logoutBtn" class="theme-btn" style="width:100%;">Logout</button>

        <div style="margin-top:14px;">
          <button id="viewUserBtn" class="theme-btn view-btn-inactive" style="width:100%;">User view</button>
          <button id="viewAdminBtn" class="theme-btn view-btn-inactive" style="width:100%; margin-top:10px;">Admin view</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Add Car Modal -->
<div class="settings-overlay" id="addCarOverlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="settings-modal" style="max-width:520px;" tabindex="-1" aria-label="Add car">
    <div class="settings-header">
      <h2>Add Car</h2>
      <button class="close-btn" id="closeAddCar" aria-label="Close add car">√ó</button>
    </div>

    <p class="modal-note">All fields are optional. Blank values won‚Äôt break the listing.</p>

    <div class="form-grid">
      <div class="form-row">
        <label for="newCarTitle">Car name</label>
        <input id="newCarTitle" type="text" placeholder="Example: 2019 BMW 330i">
      </div>

      <div class="form-row">
        <label for="newCarPrice">Price</label>
        <input id="newCarPrice" type="text" inputmode="numeric" placeholder="Example: 24999">
      </div>

      <div class="form-row">
        <label for="newCarMileage">Mileage</label>
        <input id="newCarMileage" type="text" inputmode="numeric" placeholder="Example: 65000">
      </div>
    </div>

    <div class="modal-actions">
      <button class="mini-btn" id="cancelAddCar" type="button">Cancel</button>
      <button class="mini-btn primary" id="submitAddCar" type="button">Add</button>
    </div>
  </div>
</div>

<!-- Pretty confirm modal -->
<div class="pab-confirm-overlay" id="pabConfirmOverlay" aria-hidden="true">
  <div class="pab-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="pabConfirmTitle">
    <div class="pab-confirm-head">
      <div class="pab-confirm-title" id="pabConfirmTitle">
        <span class="pab-confirm-icon" id="pabConfirmIcon">?</span>
        <span id="pabConfirmTitleText">Confirm</span>
      </div>
      <button class="pab-confirm-close" id="pabConfirmClose" type="button" aria-label="Close">√ó</button>
    </div>
    <div class="pab-confirm-body" id="pabConfirmMsg">Are you sure?</div>
    <div class="pab-confirm-actions">
      <button class="pab-confirm-btn cancel" id="pabConfirmCancel" type="button">Cancel</button>
      <button class="pab-confirm-btn ok" id="pabConfirmOk" type="button">OK</button>
    </div>
  </div>
</div>

<section class="hero" id="home">
  <div class="container">
    <h1>Find your next car</h1>
    <p>Clean listings. Clear pricing. Direct contact.</p>

    <div class="controls">
      <div class="search"><input id="q" placeholder="Search by make, model, year..." autocomplete="off"></div>
      <a class="btn" href="#cars">Browse Cars</a>

      <button class="btn admin-only" id="addCarBtn" style="display:none;">
        + Add Car
      </button>
    </div>

    <a class="sold-link" href="sold.html">View Sold Cars ‚Üí</a>
  </div>
</section>

<section id="cars" class="container">
  <div class="grid" id="grid"></div>
  <div id="gridStatus" class="grid-status" aria-live="polite"></div>
</section>

<section id="contact" class="container">
  <h2>Contact Us</h2>
  <p>Contact us for more information</p>
  <div class="contact-buttons">
    <a href="tel:+15165657312" class="contact-btn">üìû Call: +1 (516) 565-7312</a>
    <a href="mailto:pabshopcars@gmail.com" class="contact-btn email">‚úâÔ∏è Email Us</a>
    <a href="tel:+15857347880" class="contact-btn secondary">üìû Call: +1 (585) 734-7880</a>
  </div>
</section>

<footer>
  <div class="container">
    <p>
      This website is a demo vehicle inventory and listing platform for a private auto business.
      No payments are processed and no sensitive personal information is collected.
    </p>
    <p>¬© 2025 PAB SHOP. All rights reserved.</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const SUPABASE_URL = "https://liipbpmjqjqxkuflufkv.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxpaXBicG1qcWpxeGt1Zmx1Zmt2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5MTg0MjYsImV4cCI6MjA4MTQ5NDQyNn0.LrIRgiVCE6E9vyXduQZEkdKAmmLDij2kQN2ajjavTS8";
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const DEFAULT_COVER = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
    <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
      <defs>
        <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#0b6eff" stop-opacity="0.25"/>
          <stop offset="1" stop-color="#000000" stop-opacity="0.08"/>
        </linearGradient>
      </defs>
      <rect width="1200" height="700" fill="url(#g)"/>
      <text x="60" y="120" fill="rgba(255,255,255,0.75)" font-size="56" font-family="Inter, Arial, sans-serif" font-weight="700">PAB SHOP</text>
      <text x="60" y="190" fill="rgba(255,255,255,0.55)" font-size="28" font-family="Inter, Arial, sans-serif" font-weight="600">No cover image</text>
    </svg>
  `);

  window.isAdmin = false;
  function $(id){ return document.getElementById(id); }

  /**********************
   * Theme + Mobile layout
   **********************/
  const root = document.documentElement;

  const savedTheme = localStorage.getItem('theme') || 'dark';
  root.setAttribute('data-theme', savedTheme);

  const savedMobileGrid = localStorage.getItem('mobileGrid') || 'single';
  root.setAttribute('data-mobile-grid', savedMobileGrid);

  function updateThemeButtons() {
    const currentTheme = root.getAttribute('data-theme');
    document.querySelectorAll('.theme-btn[data-theme]').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.theme === currentTheme);
    });
  }

  function updateLayoutButtons(){
    const mode = root.getAttribute('data-mobile-grid') || 'single';
    const a = $("layoutSingleBtn");
    const b = $("layoutDoubleBtn");
    if (!a || !b) return;
    a.classList.toggle("active", mode === "single");
    b.classList.toggle("active", mode === "double");
  }

  updateThemeButtons();
  updateLayoutButtons();

  document.querySelectorAll('.theme-btn[data-theme]').forEach(btn => {
    btn.onclick = () => {
      const theme = btn.dataset.theme;
      if (!theme) return;
      root.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      updateThemeButtons();
    };
  });

  $("layoutSingleBtn")?.addEventListener("click", () => {
    root.setAttribute("data-mobile-grid", "single");
    localStorage.setItem("mobileGrid", "single");
    updateLayoutButtons();
  });

  $("layoutDoubleBtn")?.addEventListener("click", () => {
    root.setAttribute("data-mobile-grid", "double");
    localStorage.setItem("mobileGrid", "double");
    updateLayoutButtons();
  });

  /**********************
   * View mode helpers
   **********************/
  function getViewMode(){ return localStorage.getItem("viewMode") || "admin"; }
  function setViewMode(mode){
    localStorage.setItem("viewMode", mode);
    updateViewButtons();
    applyAdminView();
    // re-render grid so admin-only buttons appear/disappear correctly
    try{ renderAll(); }catch(e){ console.warn('renderAll failed', e); }
  }
  function canSeeAdminNow(){
    return window.isAdmin && (getViewMode() !== "user");
  }

  function updateViewButtons(){
    const mode = getViewMode();
    const userBtn = $("viewUserBtn");
    const adminBtn = $("viewAdminBtn");
    if (!userBtn || !adminBtn) return;

    if (mode === "admin"){
      adminBtn.classList.add("view-btn-active");
      adminBtn.classList.remove("view-btn-inactive");
      userBtn.classList.add("view-btn-inactive");
      userBtn.classList.remove("view-btn-active");
    } else {
      userBtn.classList.add("view-btn-active");
      userBtn.classList.remove("view-btn-inactive");
      adminBtn.classList.add("view-btn-inactive");
      adminBtn.classList.remove("view-btn-active");
    }
  }

  function applyAdminView(){
    const adminEls = document.querySelectorAll(".admin-only");
    const canSee = canSeeAdminNow();
    adminEls.forEach(el => { el.style.display = canSee ? "" : "none"; });
  }

  async function refreshAuthUI(){
    const { data: { session } } = await db.auth.getSession();
    window.isAdmin = !!session;

    const adminSection = $("adminSection");
    const ownerLoginSection = $("ownerLoginSection");

    const outBox = $("authLoggedOut");
    const inBox  = $("authLoggedIn");
    const emailLabel = $("adminEmailLabel");

    if (window.isAdmin){
      if (adminSection) adminSection.style.display = "";
      if (ownerLoginSection) ownerLoginSection.style.display = "none";
    } else {
      if (adminSection) adminSection.style.display = "none";
      if (ownerLoginSection) ownerLoginSection.style.display = "";
    }

    if (outBox) outBox.style.display = window.isAdmin ? "none" : "";
    if (inBox)  inBox.style.display  = window.isAdmin ? "" : "none";

    if (emailLabel){
      emailLabel.textContent = session?.user?.email ? `Logged in as: ${session.user.email}` : "";
    }

    applyAdminView();
    updateViewButtons();
  }

  async function loginOwner(){
    const email = $("adminEmail")?.value?.trim();
    const password = $("adminPassword")?.value;
    if (!email || !password) return alert("Enter email + password.");

    const { error } = await db.auth.signInWithPassword({ email, password });
    if (error){ console.error(error); return alert("Login failed."); }

    await refreshAuthUI();
    try{ renderAll(); }catch(e){ /* ignore */ }
  }

  async function logoutOwner(){
    const { error } = await db.auth.signOut();
    if (error) console.error(error);

    await refreshAuthUI();
    try{ renderAll(); }catch(e){ /* ignore */ }
  }

  /**********************
   * Settings modal (FIX)
   **********************/
  let LAST_FOCUSED_EL = null;

  function openSettings(){
    const overlay = $("settingsOverlay");
    if (!overlay) return;

    LAST_FOCUSED_EL = document.activeElement;

    overlay.classList.add("active");
    overlay.setAttribute("aria-hidden", "false");

    const modal = overlay.querySelector(".settings-modal");
    if (modal) setTimeout(() => modal.focus(), 0);
  }

  function closeSettings(){
    const overlay = $("settingsOverlay");
    if (!overlay) return;

    overlay.classList.remove("active");
    overlay.setAttribute("aria-hidden", "true");

    if (LAST_FOCUSED_EL && typeof LAST_FOCUSED_EL.focus === "function"){
      try { LAST_FOCUSED_EL.focus(); } catch(_) {}
    }
    LAST_FOCUSED_EL = null;
  }

  /**********************
   * Pretty confirm modal helper
   **********************/
  const PAB_CONFIRM = {
    open: false,
    resolver: null,
    escHandler: null,

    show({ title="Confirm", message="Are you sure?", okText="OK", cancelText="Cancel", danger=false, icon="?" }){
      return new Promise((resolve) => {
        const overlay = $("pabConfirmOverlay");
        const titleText = $("pabConfirmTitleText");
        const msg = $("pabConfirmMsg");
        const okBtn = $("pabConfirmOk");
        const cancelBtn = $("pabConfirmCancel");
        const closeBtn = $("pabConfirmClose");
        const iconEl = $("pabConfirmIcon");
        if (!overlay || !titleText || !msg || !okBtn || !cancelBtn || !closeBtn || !iconEl){
          resolve(window.confirm(message));
          return;
        }

        this.open = true;
        this.resolver = resolve;

        titleText.textContent = title;
        msg.textContent = message;
        iconEl.textContent = icon;

        okBtn.textContent = okText;
        cancelBtn.textContent = cancelText;

        okBtn.classList.remove("danger","ok","warn");
        if (danger) okBtn.classList.add("danger");
        else okBtn.classList.add("warn");

        const finish = (val) => {
          if (!this.open) return;
          this.open = false;

          overlay.classList.remove("active");
          overlay.style.display = "none";
          overlay.setAttribute("aria-hidden", "true");

          okBtn.onclick = null;
          cancelBtn.onclick = null;
          closeBtn.onclick = null;

          if (this.escHandler){
            document.removeEventListener("keydown", this.escHandler);
            this.escHandler = null;
          }

          const r = this.resolver;
          this.resolver = null;
          if (typeof r === "function") r(val);
        };

        okBtn.onclick = () => finish(true);
        cancelBtn.onclick = () => finish(false);
        closeBtn.onclick = () => finish(false);

        overlay.onclick = (e) => { if (e.target === overlay) finish(false); };

        this.escHandler = (e) => { if (e.key === "Escape") finish(false); };
        document.addEventListener("keydown", this.escHandler);

        overlay.style.display = "flex";
        overlay.setAttribute("aria-hidden", "false");
        requestAnimationFrame(() => overlay.classList.add("active"));
        setTimeout(() => okBtn.focus(), 50);
      });
    }
  };

  /**********************
   * Helpers
   **********************/
  const NF = new Intl.NumberFormat("en-US");

  function normalizeDigits(str){
    return String(str || "").replace(/[^\d]/g, "").trim();
  }

  function formatPrice(p){
    if (p === null || p === undefined || p === "") return "Call for price";
    const n = Number(p);
    if (!Number.isFinite(n)) return "Call for price";
    return `$${NF.format(Math.round(n))}`;
  }

  function formatMileage(m){
    if (m === null || m === undefined || m === "") return "";
    const n = Number(m);
    if (!Number.isFinite(n)) return "";
    return `${NF.format(Math.round(n))} mi`;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function setGridStatus(text, spinner=false){
    const el = document.getElementById("gridStatus");
    if (!el) return;
    if (!text){
      el.classList.remove("show");
      el.innerHTML = "";
      return;
    }
    el.classList.add("show");
    el.innerHTML = escapeHtml(text) + (spinner ? `<div class="grid-spinner" aria-hidden="true"></div>` : ``);
  }

  function debounce(fn, wait=220){
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }

  function uniq(arr){ return Array.from(new Set((arr || []).filter(Boolean))); }

  function urlToStoragePath(url){
    const marker = "/storage/v1/object/public/cars/";
    const idx = String(url || "").indexOf(marker);
    if (idx === -1) return null;
    return String(url).substring(idx + marker.length);
  }

  function deriveCardImageUrl(url){
    const s = String(url || "");
    if (!s) return s;

    // If it's already a full URL (Supabase or Cloudinary secure_url)
    if (isFullUrl(s)){
      if (s.includes("/card/")) return s;
      if (s.includes("/full/")) return s.replace("/full/", "/card/");
      if (s.includes("/thumb/")) return s.replace("/thumb/", "/card/");
      return s;
    }

    // Otherwise treat it as Cloudinary public_id
    return cloudinaryCardUrl(s);
  }

  function deriveFallbackFullUrl(url){
    const s = String(url || "");
    if (!s) return s;

    // If it's Supabase-like URL, convert /card/ or /thumb/ to /full/
    if (isFullUrl(s)){
      if (s.includes("/card/")) return s.replace("/card/", "/full/");
      if (s.includes("/thumb/")) return s.replace("/thumb/", "/full/");
      return s;
    }

    // If it's a public_id, return Cloudinary full
    return cloudinaryFullUrl(s);
  }

  // ===== Cloudinary helpers (index.html) =====
  const CLOUDINARY = { cloudName: "dhhbcpnez" };

  function isFullUrl(val){
    return typeof val === "string" && (val.startsWith("http://") || val.startsWith("https://"));
  }

  function cloudinaryEncodeId(id){
    return String(id).split("/").map(encodeURIComponent).join("/");
  }

  function cloudinaryCardUrl(publicId){
    const pid = cloudinaryEncodeId(publicId);
    return `https://res.cloudinary.com/${CLOUDINARY.cloudName}/image/upload/f_auto,q_auto,w_900,c_fill/${pid}`;
  }

  function cloudinaryFullUrl(publicId){
    const pid = cloudinaryEncodeId(publicId);
    return `https://res.cloudinary.com/${CLOUDINARY.cloudName}/image/upload/f_auto,q_auto/${pid}`;
  }

  async function deleteAllCarImagesFromStorage(car){
    const urls = uniq([...(car?.images || []), car?.cover_image]);
    const paths = uniq(urls.map(urlToStoragePath).filter(Boolean));

    const extra = [];
    for (const p of paths){
      if (p.includes("/full/")){
        extra.push(p.replace("/full/","/thumb/"));
        extra.push(p.replace("/full/","/card/"));
      }
      if (p.includes("/thumb/")){
        extra.push(p.replace("/thumb/","/full/"));
        extra.push(p.replace("/thumb/","/card/"));
      }
      if (p.includes("/card/")){
        extra.push(p.replace("/card/","/full/"));
        extra.push(p.replace("/card/","/thumb/"));
      }
    }

    const all = uniq([...paths, ...extra]).filter(Boolean);
    if (!all.length) return;

    const { error } = await db.storage.from("cars").remove(all);
    if (error) throw error;
  }

  function buildSearchText(car){
    const parts = [
      car?.title,
      car?.make,
      car?.model,
      car?.year,
      car?.engine,
      car?.transmission,
      car?.drivetrain,
      car?.exterior_color,
      car?.interior_color
    ].filter(Boolean);
    return parts.join(" ").toLowerCase();
  }

  function getCoverUrls(car){
    const cover = car?.cover_image || DEFAULT_COVER;
    if (!cover || cover === DEFAULT_COVER){
      return { primary: DEFAULT_COVER, fallback: DEFAULT_COVER };
    }
    const primary = deriveCardImageUrl(cover);
    const fallback = deriveFallbackFullUrl(primary) || cover;
    return { primary, fallback };
  }

  /**********************
   * Cars grid (paged + infinite)
   **********************/
  const GRID_STATE = {
    pageSize: 10,
    offset: 0,
    loading: false,
    done: false,
    allLoadedCars: [],
    search: "",
    observer: null
  };

  function createCard(car){
    const showAdminControls = canSeeAdminNow();
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.search = buildSearchText(car);

    card.addEventListener("click", () => {
      window.location.href = `cars/cars.html?id=${car.id}`;
    });

    const title = car.title || "Untitled Car";
    const { primary, fallback } = getCoverUrls(car);
    const mileageLine = formatMileage(car.mileage);
    const priceLine = formatPrice(car.price);

    card.innerHTML = `
      <div class="card-img-wrap">
        <img
          src="${escapeHtml(primary)}"
          data-fallback="${escapeHtml(fallback)}"
          alt="${escapeHtml(title)}"
          loading="lazy"
          decoding="async"
          width="1200"
          height="675"
        >
      </div>
      <div class="card-body">
        <h3>${escapeHtml(title)}</h3>
        <div class="price">${escapeHtml(priceLine)}</div>
        <p>${escapeHtml(mileageLine)}</p>

        ${showAdminControls ? `
          <div class="action-buttons admin-only">
            <button class="action-btn sold" data-action="mark-sold" type="button">Mark Sold</button>
            <button class="action-btn delete" data-action="delete" type="button">Delete</button>
          </div>
        ` : ``}
      </div>
    `;

    const img = card.querySelector("img");
    if (img){
      img.addEventListener("error", () => {
        const fb = img.getAttribute("data-fallback");
        if (fb && img.src !== fb) img.src = fb;
      }, { once:true });
    }

    if (showAdminControls){
      card.querySelectorAll("button").forEach(btn => btn.addEventListener("click", e => e.stopPropagation()));

      card.querySelector('[data-action="mark-sold"]')?.addEventListener("click", async () => {
        const ok = await PAB_CONFIRM.show({
          title: "Mark as sold",
          message: "Mark this car as SOLD? It will no longer appear as available.",
          okText: "Mark Sold",
          cancelText: "Cancel",
          danger: false,
          icon: "‚ö†Ô∏è"
        });
        if (!ok) return;

        const { error } = await db.from("cars").update({ status: "sold" }).eq("id", car.id);
        if (error){ console.error(error); alert("Failed."); return; }

        GRID_STATE.allLoadedCars = GRID_STATE.allLoadedCars.filter(c => c.id !== car.id);
        renderAll();
      });

      card.querySelector('[data-action="delete"]')?.addEventListener("click", async () => {
        const ok = await PAB_CONFIRM.show({
          title: "Delete car",
          message: "Delete this car AND all its photos? (no undo)",
          okText: "Delete",
          cancelText: "Cancel",
          danger: true,
          icon: "üóë"
        });
        if (!ok) return;

        try{
          await deleteAllCarImagesFromStorage(car);
          const { error } = await db.from("cars").delete().eq("id", car.id);
          if (error) throw error;

          GRID_STATE.allLoadedCars = GRID_STATE.allLoadedCars.filter(c => c.id !== car.id);
          renderAll();
        } catch(err){
          console.error(err);
          alert("Delete failed. Check console.");
        }
      });
    }

    return card;
  }

  function renderAll(){
    const grid = document.getElementById("grid");
    if (!grid) return;

    grid.innerHTML = "";

    const term = GRID_STATE.search.toLowerCase().trim();
    const filtered = term
      ? GRID_STATE.allLoadedCars.filter(c => buildSearchText(c).includes(term))
      : GRID_STATE.allLoadedCars.slice();

    if (term && !filtered.length){
      setGridStatus("No results found.", false);
    } else if (!GRID_STATE.loading && GRID_STATE.done && !term){
      setGridStatus("You reached the end.", false);
    } else if (!GRID_STATE.loading && !filtered.length && GRID_STATE.done){
      setGridStatus("No cars available.", false);
    } else {
      setGridStatus("", false);
    }

    const frag = document.createDocumentFragment();
    filtered.forEach(car => frag.appendChild(createCard(car)));
    grid.appendChild(frag);

    applyAdminView();
    rewireInfiniteObserver();
  }

  async function fetchNextPage(){
    if (GRID_STATE.loading || GRID_STATE.done) return;
    GRID_STATE.loading = true;

    setGridStatus(GRID_STATE.allLoadedCars.length ? "Loading more‚Ä¶" : "Loading cars‚Ä¶", true);

    try{
      const from = GRID_STATE.offset;
      const to = GRID_STATE.offset + GRID_STATE.pageSize - 1;

      let res = await db
        .from("cars")
        .select("*")
        .eq("status", "available")
        .order("created_at", { ascending: false })
        .range(from, to);

      if (res.error){
        console.warn("Order by created_at failed, falling back:", res.error);
        res = await db
          .from("cars")
          .select("*")
          .eq("status", "available")
          .range(from, to);
      }

      const { data, error } = res;
      if (error) throw error;

      const batch = (data || []);
      if (!batch.length){
        GRID_STATE.done = true;
        GRID_STATE.loading = false;
        renderAll();
        return;
      }

      GRID_STATE.offset += batch.length;

      // de-dupe just in case
      const existing = new Set(GRID_STATE.allLoadedCars.map(c => c.id));
      batch.forEach(c => { if (!existing.has(c.id)) GRID_STATE.allLoadedCars.push(c); });

      GRID_STATE.loading = false;
      renderAll();
    } catch(err){
      console.error(err);
      GRID_STATE.loading = false;
      setGridStatus("Couldn‚Äôt load inventory. Try again.", false);
    }
  }

  function rewireInfiniteObserver(){
    if (GRID_STATE.observer){
      GRID_STATE.observer.disconnect();
      GRID_STATE.observer = null;
    }

    // don't infinite-load while searching
    if (GRID_STATE.search.trim()) return;
    if (GRID_STATE.loading || GRID_STATE.done) return;

    const cards = Array.from(document.querySelectorAll("#grid .card"));
    if (!cards.length) return;

    const idx = Math.max(0, cards.length - 5);
    const target = cards[idx];
    if (!target) return;

    GRID_STATE.observer = new IntersectionObserver((entries) => {
      if (entries.some(e => e.isIntersecting)){
        fetchNextPage();
      }
    }, {
      root: null,
      threshold: 0.1,
      rootMargin: "600px 0px"
    });

    GRID_STATE.observer.observe(target);
  }

  /**********************
   * Search filter (debounced)
   **********************/
  const onSearch = debounce((val) => {
    GRID_STATE.search = String(val || "");
    renderAll();
  }, 220);

  document.getElementById("q")?.addEventListener("input", (e) => onSearch(e.target.value));

  /**********************
   * Add Car modal
   **********************/
  const closeAddCar = () => document.getElementById("addCarOverlay").classList.remove("active");

  document.getElementById("addCarBtn")?.addEventListener("click", () => {
    if (!canSeeAdminNow()) return;
    document.getElementById("newCarTitle").value = "";
    document.getElementById("newCarPrice").value = "";
    document.getElementById("newCarMileage").value = "";
    document.getElementById("addCarOverlay").classList.add("active");
  });

  document.getElementById("closeAddCar")?.addEventListener("click", closeAddCar);
  document.getElementById("cancelAddCar")?.addEventListener("click", closeAddCar);

  document.getElementById("addCarOverlay")?.addEventListener("click", (e) => {
    if (e.target.id === "addCarOverlay") closeAddCar();
  });

  // Prevent double-submit + make it appear instantly
  let ADDING_CAR = false;

  document.getElementById("submitAddCar")?.addEventListener("click", async () => {
    if (!canSeeAdminNow()) return;
    if (ADDING_CAR) return;

    ADDING_CAR = true;
    const submitBtn = document.getElementById("submitAddCar");
    const oldText = submitBtn?.textContent || "Add";
    if (submitBtn){
      submitBtn.disabled = true;
      submitBtn.textContent = "Adding‚Ä¶";
      submitBtn.style.opacity = "0.85";
      submitBtn.style.cursor = "not-allowed";
    }

    try{
      const title = document.getElementById("newCarTitle")?.value?.trim() || "Untitled Car";

      const priceRaw = normalizeDigits(document.getElementById("newCarPrice")?.value);
      const price = priceRaw === "" ? null : Number(priceRaw);
      const safePrice = Number.isFinite(price) ? price : null;

      const mileageRaw = normalizeDigits(document.getElementById("newCarMileage")?.value);
      const mileage = mileageRaw === "" ? null : Number(mileageRaw);
      const safeMileage = Number.isFinite(mileage) ? mileage : null;

      const payload = {
        title,
        price: safePrice,
        mileage: safeMileage,
        status: "available",
        cover_image: DEFAULT_COVER,
        images: [],
        description: ""
      };

      const { data, error } = await db.from("cars").insert([payload]).select();
      if (error) {
        console.error("INSERT ERROR:", error);
        alert("Add car failed: " + (error.message || "unknown error"));
        return;
      }

      closeAddCar();

      const created = Array.isArray(data) ? data[0] : null;
      if (created && created.id){
        // ensure it shows immediately at the top, even with paging
        GRID_STATE.search = "";
        const q = document.getElementById("q");
        if (q) q.value = "";

        GRID_STATE.allLoadedCars = GRID_STATE.allLoadedCars.filter(c => c.id !== created.id);
        GRID_STATE.allLoadedCars.unshift(created);

        // keep paging from skipping a row
        GRID_STATE.offset = Math.max(0, GRID_STATE.offset + 1);

        renderAll();
      } else {
        // fallback refresh
        GRID_STATE.offset = 0;
        GRID_STATE.done = false;
        GRID_STATE.allLoadedCars = [];
        GRID_STATE.search = "";
        await fetchNextPage();
      }
    } finally{
      ADDING_CAR = false;
      if (submitBtn){
        submitBtn.disabled = false;
        submitBtn.textContent = oldText;
        submitBtn.style.opacity = "";
        submitBtn.style.cursor = "";
      }
    }
  });

  /**********************
   * DOM wiring
   **********************/
  document.addEventListener("DOMContentLoaded", async () => {
    document.getElementById("loginBtn")?.addEventListener("click", loginOwner);
    document.getElementById("logoutBtn")?.addEventListener("click", logoutOwner);

    // ‚úÖ FIX: Settings button wiring
    $("settingsToggle")?.addEventListener("click", openSettings);
    $("closeSettings")?.addEventListener("click", closeSettings);
    $("settingsOverlay")?.addEventListener("click", (e) => {
      if (e.target && e.target.id === "settingsOverlay") closeSettings();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const overlay = $("settingsOverlay");
        if (overlay && overlay.classList.contains("active")) closeSettings();
      }
    });

    document.getElementById("showOwnerLoginBtn")?.addEventListener("click", () => {
      const adminSection = document.getElementById("adminSection");
      const ownerLoginSection = document.getElementById("ownerLoginSection");

      if (adminSection) adminSection.style.display = "";
      if (ownerLoginSection) ownerLoginSection.style.display = "none";

      const outBox = document.getElementById("authLoggedOut");
      const inBox  = document.getElementById("authLoggedIn");
      if (outBox) outBox.style.display = "";
      if (inBox) inBox.style.display = "none";
    });

    document.getElementById("viewUserBtn")?.addEventListener("click", () => setViewMode("user"));
    document.getElementById("viewAdminBtn")?.addEventListener("click", () => setViewMode("admin"));

    updateViewButtons();

    await refreshAuthUI();

    // initial load: first 10 cars
    GRID_STATE.offset = 0;
    GRID_STATE.done = false;
    GRID_STATE.loading = false;
    GRID_STATE.allLoadedCars = [];
    GRID_STATE.search = "";
    const q = document.getElementById("q");
    if (q) q.value = "";
    document.getElementById("grid").innerHTML = "";
    setGridStatus("Loading cars‚Ä¶", true);
    await fetchNextPage();

    db.auth.onAuthStateChange(async () => {
      await refreshAuthUI();
      // No refetch needed, just re-render so admin buttons show/hide correctly
      renderAll();
    });
  });
</script>

</body>
</html>